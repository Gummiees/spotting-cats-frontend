@if(catNotFound()) {
  <app-not-found />
} @else {
  <app-header [title]="title()" />
<main class="p-3 flex flex-col">
  <div class="p-4 bg-white rounded-sm shadow-sm flex flex-col gap-2 flex-1">
    <app-image-input
      [triggerClick]="triggerFileInput()"
      (selected)="onFilesSelected()"
      (processed)="onFilesProcessed($event)"
      (error)="onFilesError($event)"
    />
    <app-primary-button 
    buttonText="Upload Photos" 
      [isLoading]="isLoading()" 
      [isDisabled]="isImageLimitReached()"
      (onClick)="onUploadPhotosClick()"
    />
    
    @if (totalImages() > 0) {
      <div class="text-sm text-gray-600 mb-2">
        {{ totalImages() }} of {{ MAX_IMAGES }} images uploaded
      </div>
      <div class="flex gap-2 mt-2 overflow-x-auto pb-2">
        @for (imageUrl of formImages(); track imageUrl) {
          <app-cat-form-image
            [imageUrl]="imageUrl"
            [imageName]="imageUrl"
            (removeFile)="removeFormImage(imageUrl)"
          />
        }
        @for (file of files(); track file) {
          <app-cat-form-image
            [imageUrl]="getImageUrl(file)"
            [imageName]="file.name"
            [file]="file"
            (removeFile)="removeFile(file)"
          />
        }
      </div>
    }


    <div class="w-full flex-1 rounded-md min-h-[200px] sm:min-h-[300px]" leaflet [leafletOptions]="leafletOptions()" (leafletMapReady)="onMapReady($event)">
    </div>
    
    <form [formGroup]="catForm" class="flex flex-col gap-3">
      <div class="flex flex-col gap-2">
        <label class="text-sm font-medium flex items-center gap-1" for="name">
          Name
          <div class="flex items-top gap-1">
            <span class="text-red-500">*</span>
            <span class="text-red-500 text-xs">required</span>
          </div>
        </label>
        <input class="border border-gray-300 rounded-sm p-2 placeholder-gray-500" type="text" id="name" formControlName="name" placeholder="Enter cat's name" />
        @if (catForm.get('name')?.invalid && catForm.get('name')?.touched) {
          <span class="text-red-500 text-sm">Name is required</span>
        }
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-sm font-medium" for="age">Age</label>
        <input class="border border-gray-300 rounded-sm p-2 placeholder-gray-500" type="number" id="age" max="30" min="0" formControlName="age" placeholder="Enter age (0-30)" />
        @if (catForm.get('age')?.invalid && catForm.get('age')?.touched) {
          <span class="text-red-500 text-sm">Age must be between 0 and 30</span>
        }
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-sm font-medium" for="breed">Breed</label>
        <app-searchable-dropdown
          [options]="breedOptions()"
          placeholder="Search cat breeds..."
          buttonText="Select breed"
          [selectedValue]="catForm.get('breed')?.value || null"
          [isOpen]="isBreedDropdownOpen()"
          (selectionChange)="onBreedSelectionChange($event)"
          (openChange)="onBreedDropdownOpenChange($event)"
        />
        @if (catForm.get('breed')?.invalid && catForm.get('breed')?.touched) {
          @if (catForm.get('breed')?.errors?.['breedFormat']) {
            <span class="text-red-500 text-sm">Breed can only contain letters, numbers, spaces, hyphens, and underscores</span>
          } @else if (catForm.get('breed')?.errors?.['breedInvalid']) {
            <span class="text-red-500 text-sm">Please select a valid breed from the dropdown</span>
          } @else if (catForm.get('breed')?.errors?.['maxlength']) {
            <span class="text-red-500 text-sm">Breed must be less than 100 characters</span>
          }
        }
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-sm font-medium" for="extraInfo">Extra Info</label>
        <textarea class="border border-gray-300 rounded-sm p-2 placeholder-gray-500" id="extraInfo" rows="3" maxlength="1000" formControlName="extraInfo" placeholder="Add any additional information about the cat..."></textarea>
        @if (catForm.get('extraInfo')?.invalid && catForm.get('extraInfo')?.touched) {
          <span class="text-red-500 text-sm">Extra Info must be less than 1000 characters</span>
        }
      </div>
      <div class="flex flex gap-2 items-center">
        <label class="text-sm font-medium" for="isDomestic">Is domestic?</label>
        <app-nullable-switch class="self-start" formControlName="isDomestic" />
        <div class="text-sm text-gray-500">{{ getBooleanValueFromFormControlName('isDomestic') }}</div>
      </div>
      <div class="flex flex gap-2 items-center">
        <label class="text-sm font-medium" for="isMale">What sex is it?</label>
        <app-nullable-switch class="self-start" trueColor="bg-sky-500" falseColor="bg-fuchsia-500" formControlName="isMale" />
        <div class="text-sm text-gray-500">{{ getSexValue() }}</div>
      </div>
      <div class="flex flex gap-2 items-center">
        <label class="text-sm font-medium" for="isSterilized">Is sterilized?</label>
        <app-nullable-switch class="self-start" formControlName="isSterilized" />
        <div class="text-sm text-gray-500">{{ getBooleanValueFromFormControlName('isSterilized') }}</div>
      </div>
      <div class="flex flex gap-2 items-center">
        <label class="text-sm font-medium" for="isFriendly">Is friendly?</label>
        <app-nullable-switch class="self-start" formControlName="isFriendly" />
        <div class="text-sm text-gray-500">{{ getBooleanValueFromFormControlName('isFriendly') }}</div>
      </div>
      <app-primary-button 
        class="self-end"
        buttonText="Save"
        [isDisabled]="catForm.invalid"
        [isLoading]="isLoading()" 
        (onClick)="onSaveClick()"
      />
    </form>
  </div>
</main>
}